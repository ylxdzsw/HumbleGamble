"use strict";const init_backend=()=>{chrome.runtime.sendMessage({action:"init"}),sessionStorage.setItem("inited","1")},on_index_update=e=>{const t={index:e,contract:current_contract(),...collect_info(),time:+new Date};is_recording()?savedata("pulse",[t]):console.log(t),chrome.runtime.sendMessage({action:"pulse",data:t},handle_rpc)},get_kline=async()=>{if(get_kline.kline&&Date.now()-get_kline.kline[get_kline.kline.length-1].time<12e4)return get_kline.kline;if(!get_kline.queue){const e="/future_kline.do?symbol=btc_usd&type=1min&contract_type=this_week"+(get_kline.kline?"&since="+get_kline.kline[get_kline.kline.length-1].time:"");get_kline.queue=okget(e).then(e=>{const t=JSON.parse(e).map(([e,t,n,o,a,r])=>({time:e,high:n,low:o,close:a,volume:r,contract:current_contract()})).slice(0,-1);return is_recording()&&savedata("kline",t),delete get_kline.queue,get_kline.kline=(get_kline.kline||[]).concat(t).slice(-2644)})}return get_kline.queue},on_candle=async()=>{const e=await get_kline();if((Date.now()-e[e.length-1].time)/1e3>120)return await sleep(1),on_candle();chrome.runtime.sendMessage({action:"candle",data:e},handle_rpc)},depth_info=(e,t)=>{const n=e[e.length-1].cumulative,o=t[t.length-1].cumulative;let a=e[e.length-1].price;for(const{price:t,cumulative:n}of e)if(n>1){a=t;break}let r=t[t.length-1].price;for(const{price:e,cumulative:n}of t)if(n>1){r=e;break}return{ask1:a,bid1:r,askd:n/(n+o),bidd:o/(n+o)}},handle_rpc=e=>{for(const{action:t,data:n}of e)switch(t){case"prediction":display_pred(n);break;case"suggestion":display_suggestion(n);break;case"gamble":is_gambling()&&gamble(n);break;default:throw new Error("unknown action "+t)}},dispatch=async()=>{switch(!1){case!("https://www.okex.com/future/futureFullNew.do?symbol=0"==location.href):init_fullscreen();break;default:return}sessionStorage.getItem("inited")||init_backend()};setTimeout(dispatch,0);const ready=()=>["#priceIndex .indexNumber > em",".orderListBody > .topData",".contract.cur"].map($).every(e=>e),observe_index=e=>{const t=$("#priceIndex .indexNumber > em");new MutationObserver(()=>e(parse_money(t.textContent))).observe(t,{childList:!0})},parse_depth=e=>[].map.call(e,e=>({price:parse_money(e.querySelector(".priceSpan").textContent),cumulative:parseFloat(e.querySelector(".amountBtcSpan").textContent)})),collect_info=()=>{const e=parse_money($("#priceIndex .lastPrice > em").textContent),t=parse_money($("#amount24h").textContent.slice(1)),n=parse_money($("#holdAmount").textContent.slice(1)),o=parse_depth(document.querySelectorAll("#buyDepth  > :not([style])")),a=parse_depth(document.querySelectorAll("#sellDepth > :not([style])")).reverse();return{last_price:e,amount24h:t,total_hold:n,...depth_info(a,o)}},clear_hist=()=>{const e=$("#tradeDepths");for(let t=e.children.length;t>30;t--)e.removeChild(e.lastChild)},inject_elements=()=>{const e=document.createElement("span");e.setAttribute("class","topDataSpan title2"),e.innerHTML=`\n        <input type="checkbox" id="gambling" style="position: relative; top: 3px" ${sessionStorage.getItem("gambling")?"checked":""} />\n        <label for="gambling"> Auto Gamble </label>\n    `,$(".orderListBody > .topData").appendChild(e),$("#gambling").onchange=(e=>e.target.checked?sessionStorage.setItem("gambling","1"):sessionStorage.removeItem("gambling"));const t=document.createElement("span");t.setAttribute("class","topDataSpan title2"),t.innerHTML=`\n        <input type="checkbox" id="recording" style="position: relative; top: 3px" ${sessionStorage.getItem("recording")?"checked":""} />\n        <label for="recording"> Record </label>\n    `,$(".orderListBody > .topData").appendChild(t),$("#recording").onchange=(e=>e.target.checked?sessionStorage.setItem("recording","1"):sessionStorage.removeItem("recording"));const n=document.createElement("span");n.setAttribute("class","topDataSpan title2"),n.innerHTML='<a id="export" href="#" onclick="return false"> Export </a>',$(".orderListBody > .topData").appendChild(n),$("#export").onclick=export_data;const o=document.createElement("span");o.setAttribute("class","topDataSpan title2"),o.setAttribute("style","line-height: 125%; font-size: 9px; float: right; margin-right: 10px"),o.innerHTML='\n        <span id="p0"></span> &nbsp; <span id="p1"></span> &nbsp; <span id="p2"></span> &nbsp; <span id="p3"></span><br/>\n        <span id="p8"></span> &nbsp; <span id="p9"></span> &nbsp; <span id="p10"></span> &nbsp; <span id="p11"></span><br/>\n        <span id="p16"></span> &nbsp; <span id="p17"></span> &nbsp; <span id="p18"></span> &nbsp; <span id="p19"></span>\n    ',$(".orderListBody > .topData").appendChild(o);const a=document.createElement("span");a.setAttribute("id","suggestion"),a.setAttribute("style","margin-left: 40px"),$("#positionTab").after(a)},ensure_BBO=()=>$("#match_price").checked||$("#match_price").click(),set_amount=e=>$("#amount").value=e.toFixed(2),is_recording=()=>$("#recording")&&$("#recording").checked,is_gambling=()=>$("#gambling")&&$("#gambling").checked,disable_buttons=()=>{is_recording()&&$("#recording").click(),$("#recording").disabled=!0,is_gambling()&&$("#gambling").click(),$("#gambling").disabled=!0,init_backend()},current_contract=()=>{const e=$(".contract.cur");if("1"!=e.getAttribute("type"))throw disable_buttons(),new Error("not weekly contract");const t=(new Date).toISOString().match(/\d{4}-(\d\d)-(\d\d)T(\d\d)/),n=e.textContent;if(t[1]+t[2]==n.slice(3)&&(t[3]>="02"||t[3]<="09"))throw disable_buttons(),new Error("around delivery");return n},long=async()=>{let e=!0;for(const t of $("#positoin").children)switch(t.children[2].textContent){case"Long":e=!1;break;case"Short":t.querySelector(".close_market").click(),await wait_until(()=>!$("#futureFullTipsPop").getAttribute("style").includes("none")),$("#sure").click();break;default:throw new Error("Unknown contract type")}e&&(ensure_BBO(),set_amount(.5),$("[value='Open Long']").click())},short=async()=>{let e=!0;for(const t of $("#positoin").children)switch(t.children[2].textContent){case"Short":e=!1;break;case"Long":t.querySelector(".close_market").click(),await wait_until(()=>!$("#futureFullTipsPop").getAttribute("style").includes("none")),$("#sure").click();break;default:throw new Error("Unknown contract type")}e&&(ensure_BBO(),set_amount(.05),$("[value='Open Short']").click())},display_pred=e=>{for(let t=0;t<e.length;t++)$("#p"+t)&&($("#p"+t).textContent=e[t].toFixed(4))},display_suggestion=e=>{const t=[{color:"lime",text:"Long",onclick:long},{color:"yellow",text:"Hold",onclick:()=>0},{color:"red",text:"Short",onclick:short}][e.reduce((e,t,n,o)=>t>o[e]?n:e,0)];$("#suggestion").innerHTML=`<a id="execute" href="#" onclick="return false" style="color: ${t.color}"> Suggestion: ${t.text} </a>\n                                  <span style="font-size: 10px; margin-left: 20px"> ${e.map(e=>e.toFixed(4)).join(" &nbsp; ")} </span>`,$("#execute").onclick=t.onclick},gamble=e=>[long,()=>0,short][e](),init_fullscreen=async()=>{await wait_until(ready),observe_index(on_index_update),inject_elements(),alignInterval(60,2,on_candle),alignInterval(120,0,clear_hist),on_candle()},$=e=>document.querySelector(e),sleep=e=>new Promise(t=>setTimeout(t,1e3*e)),download=(e,t)=>{const n=URL.createObjectURL(new Blob([e],{type:"application/json"})),o=document.createElement("a");o.download=t+".json",o.href=n,o.click()},okget=e=>new Promise((t,n)=>{const o=new XMLHttpRequest;o.open("GET","/api/v1"+e),o.onreadystatechange=(()=>{o.readyState==XMLHttpRequest.DONE&&(200==o.status?t:n)(o.responseText)}),o.send()}),wait_time_out=(e,t=2)=>new Promise((n,o)=>{setTimeout(()=>{o(new Error("promise time out"))},1e3*t);e.then(n).catch(o)}),wait_until=async e=>{for(;!e();)await sleep(.02)},parse_money=e=>parseFloat(e.replace(",","")),initdb=e=>{const t=indexedDB.open("humblegamble",1);t.onerror=(e=>console.error(e)),t.onupgradeneeded=(e=>{const n=t.result;n.createObjectStore("kline",{keyPath:["contract","time"]}),n.createObjectStore("pulse",{keyPath:["contract","time"]})}),t.onsuccess=(n=>{e(t.result)})},getdb=()=>new Promise(e=>{getdb.db?e(getdb.db):getdb.queue?getdb.queue.push(e):(getdb.queue=[e],initdb(e=>{getdb.db=e;for(const t of getdb.queue)t(e);delete getdb.queue}))}),getstore=async(e,t)=>(await getdb()).transaction(e,t).objectStore(e),savedata=async(e,t)=>{e=await getstore(e,"readwrite");let n=!1;for(const o of t){const t=e.add(o);t.onerror=(e=>{if(0!=t.error.code)throw e;e.preventDefault(),n=!0})}return new Promise((t,o)=>{e.transaction.oncomplete=(e=>t(n))})},export_data=async()=>{const e=Object.create(null);for(const t of["kline","pulse"]){const n=new Set;await new Promise(async(o,a)=>{(await getstore(t)).openCursor().onsuccess=(a=>{const r=event.target.result;if(r){const o=r.value.contract;n.has(o)||(e[o]=(e[o]||"")+`=== ${t} ===\n`,n.add(o)),delete r.value.contract,e[o]+=JSON.stringify(r.value)+"\n",r.continue()}else o()})})}for(const t in e)download(e[t],t)},alignInterval=async(e,t,n)=>{const o=Date.now()/1e3-t,a=1+o/e|0;await sleep(e*a-o);try{n(a)}finally{alignInterval(e,t,n)}};
//# sourceMappingURL=okex.js.map