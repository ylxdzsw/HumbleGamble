"use strict";const on_index_update=e=>{const t={index:e,...collect_info(),time:+new Date};get_kline(),is_recording()?savedata("pulse",[t]):console.log(t)},get_kline=async()=>{const e=+new Date;if(get_kline.kline&&e-get_kline.kline[get_kline.kline.length-1][0]<6e4)return get_kline.kline;if(!get_kline.queue){const e="/future_kline.do?symbol=btc_usd&type=1min&contract_type=this_week"+(get_kline.kline?"&since="+get_kline.kline[get_kline.kline.length-1][0]:"");get_kline.queue=okget(e).then(e=>{const t=JSON.parse(e).map(([e,t,n,o,i,a])=>({time:e,high:n,low:o,volume:a}));return is_recording()&&savedata("kline",t),delete get_kline.queue,get_kline.kline=(get_kline.kline||[]).concat(t).slice(-2880)})}return get_kline.queue},fuck=async e=>new Promise((t,n)=>{chrome.runtime.sendMessage(e,t)}),dispatch=async()=>{"https://www.okex.com/future/futureFullNew.do?symbol=0"==location.href&&init_fullscreen()};setTimeout(dispatch,0);const ready=()=>["#priceIndex .indexNumber > em",".orderListBody > .topData"].map($).every(e=>e),observe_index=e=>{const t=$("#priceIndex .indexNumber > em");new MutationObserver(()=>e(parse_money(t.textContent))).observe(t,{childList:!0})},collect_info=()=>{return{last_price:parse_money($("#priceIndex .lastPrice > em").textContent),total_hold:parse_money($("#holdAmount").textContent.slice(1))}},clear_hist=()=>{const e=$("#tradeDepths");for(let t=e.children.length;t>20;t--)e.removeChild(e.lastChild)},inject_elements=()=>{const e=document.createElement("span");e.setAttribute("class","topDataSpan"),e.innerHTML='\n        <input type="checkbox" id="auto_gambling" style="position: relative; top: 3px" />\n        <label for="auto_gambling"> Auto Gambling </label>\n    ',$(".orderListBody > .topData").appendChild(e);const t=document.createElement("span");t.setAttribute("class","topDataSpan"),t.innerHTML='\n        <input type="checkbox" id="record" style="position: relative; top: 3px" />\n        <label for="record"> Record </label>\n    ',$(".orderListBody > .topData").appendChild(t);const n=document.createElement("span");n.setAttribute("class","topDataSpan"),$(".orderListBody > .topData").appendChild(n)},is_recording=()=>$("#record")&&$("#record").checked,init_fullscreen=async()=>{await wait_until(ready),observe_index(on_index_update),inject_elements(),setInterval(clear_hist,12e4)},$=e=>document.querySelector(e),sleep=e=>new Promise(t=>setTimeout(t,1e3*e)),download=e=>{const t=URL.createObjectURL(new Blob([e],{type:"application/json"})),n=document.createElement("a");n.download="data.json",n.href=t,n.click()},okget=e=>new Promise((t,n)=>{const o=new XMLHttpRequest;o.open("GET","/api/v1"+e),o.onreadystatechange=(()=>{o.readyState==XMLHttpRequest.DONE&&(200==o.status?t:n)(o.responseText)}),o.send()}),wait_time_out=(e,t=2)=>new Promise((n,o)=>{setTimeout(()=>{o(new Error("promise time out"))},1e3*t);e.then(n).catch(o)}),wait_until=async e=>{for(;!e();)console.log("not yet"),await sleep(.02)},parse_money=e=>parseFloat(e.replace(",","")),initdb=e=>{const t=indexedDB.open("humblegamble",1);t.onerror=(e=>console.error(e)),t.onupgradeneeded=(e=>{const n=t.result;n.createObjectStore("kline",{keyPath:"time"}),n.createObjectStore("pulse",{keyPath:"time"})}),t.onsuccess=(n=>{e(t.result)})},getdb=()=>new Promise(e=>{getdb.db?e(getdb.db):getdb.queue?getdb.queue.push(e):(getdb.queue=[e],initdb(e=>{getdb.db=e;for(const t of getdb.queue)t(e);delete getdb.queue}))}),getstore=async(e,t)=>(await getdb()).transaction(e,t).objectStore(e),savedata=async(e,t)=>{e=await getstore(e,"readwrite");let n=!1;for(const o of t){const t=e.add(o);t.onerror=(e=>{if(0!=t.error.code)throw e;e.preventDefault(),n=!0})}return new Promise((t,o)=>{e.transaction.oncomplete=(e=>t(n))})},export_data=async()=>{let e="";const t=[].slice.call((await getdb()).objectStoreNames);for(const n of t)e+=`=== ${n} ===\n`,await new Promise(async(t,o)=>{(await getstore(n)).openCursor().onsuccess=(n=>{const o=event.target.result;o?(e+=JSON.stringify(o.value)+"\n",o.continue()):t()})});download(e)};
//# sourceMappingURL=okex.js.map